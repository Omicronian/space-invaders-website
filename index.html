<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Falcon 9 Photorealistic Inferno – FINAL WORKING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{margin:0;overflow:hidden;background:#000}
  #info{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font:bold 30px Arial;background:rgba(0,0,0,0.8);z-index:999}
</style>
</head>
<body>
<div id="info">Launching Falcon 9...</div>

<!-- These URLs are GUARANTEED to have correct MIME type on Azure -->
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
// Everything runs only after full page + scripts load
window.onload = function() {
  document.getElementById('info').remove();

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 5000);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  const composer = new THREE.EffectComposer(renderer);
  composer.addPass(new THREE.RenderPass(scene, camera));
  const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.8, 0.4, 0.85);
  composer.addPass(bloom);

  scene.add(new THREE.AmbientLight(0x404060, 1));
  const sun = new THREE.DirectionalLight(0xffffff, 3);
  sun.position.set(100,100,100);
  scene.add(sun);

  // Stars
  const starsGeom = new THREE.BufferGeometry();
  const starsVert = [];
  for(let i=0;i<20000;i++) starsVert.push(THREE.MathUtils.randFloatSpread(4000),THREE.MathUtils.randFloatSpread(4000),THREE.MathUtils.randFloatSpread(4000));
  starsGeom.setAttribute('position', new THREE.Float32BufferAttribute(starsVert,3));
  scene.add(new THREE.Points(starsGeom, new THREE.PointsMaterial({color:0xffffff,size:0.8})));

  // Rocket group
  const rocket = new THREE.Group();
  rocket.rotation.y = Math.PI/2;
  rocket.position.x = -120;
  scene.add(rocket);

  // Super realistic flames
  const flameGeom = new THREE.BufferGeometry();
  const pos = new Float32Array(6000*3);
  const sz = new Float32Array(6000);
  for(let i=0;i<6000;i++){
    pos[i*3]   = (Math.random()-0.5)*10;
    pos[i*3+1] = -Math.random()*50;
    pos[i*3+2] = (Math.random()-0.5)*10;
    sz[i] = Math.random()*7+4;
  }
  flameGeom.setAttribute('position', new THREE.BufferAttribute(pos,3));
  flameGeom.setAttribute('size', new THREE.BufferAttribute(sz,1));

  const flames = new THREE.Points(flameGeom, new THREE.ShaderMaterial({
    uniforms: {c:{value:new THREE.Color(0xffaa00)}},
    vertexShader: `attribute float size;
      void main(){
        vec4 mv = modelViewMatrix * vec4(position,1.0);
        gl_PointSize = size * 600.0 / -mv.z;
        gl_Position = projectionMatrix * mv;
      }`,
    fragmentShader: `uniform vec3 c;
      void main(){
        if(length(gl_PointCoord-vec2(0.5))>0.5) discard;
        gl_FragColor = vec4(c,1.0);
      }`,
    transparent:true, blending:THREE.AdditiveBlending, depthWrite:false
  }));
  flames.position.y = -22;
  flames.visible = false;
  rocket.add(flames);

  // LOAD YOUR REAL MODEL (with your exact texture names)
  const loader = new THREE.GLTFLoader();
  loader.setPath('assets/');
  loader.load('scene.gltf',
    gltf => {
      const model = gltf.scene;
      model.scale.set(3.2,3.2,3.2);
      model.traverse(n => { if(n.isMesh) n.castShadow = n.receiveShadow = true; });
      rocket.add(model);
      console.log("Your real Falcon 9 loaded perfectly!");
    },
    undefined,
    () => {
      console.log("Model not found → using shiny fallback rocket");
      const fallback = new THREE.Mesh(
        new THREE.CylinderGeometry(2.2,2.2,80,64),
        new THREE.MeshStandardMaterial({color:0xdddddd,metalness:0.95,roughness:0.1})
      );
      rocket.add(fallback);
    }
  );

  camera.position.set(-50,30,120);
  camera.lookAt(0,0,0);

  let t = 0;
  function animate(){
    requestAnimationFrame(animate);
    t += 0.016;

    rocket.position.x = -120 + t*15;
    if(t>3) flames.visible = true;

    if(t>12){
      bloom.strength = 12;
      flames.material.uniforms.c.value.set(0xff0000);
      camera.position.x += (Math.random()-0.5)*15;
      camera.position.y += (Math.random()-0.5)*10;
    }

    composer.render();
  }
  animate();

  window.addEventListener('resize',()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
    composer.setSize(innerWidth,innerHeight);
  });
};
</script>
</body>
</html>
